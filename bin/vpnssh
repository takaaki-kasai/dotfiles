#!/bin/bash

vpn='VPN ConoHa'

function isnt_connected() {
  /usr/sbin/scutil --nc status "$vpn" | sed -n 1p | grep -qv Connected
}

function poll_until_connected() {
  while isnt_connected "$vpn"; do
    sleep 1
  done
  true
}

while true; do
  echo "$(date '+%Y-%m-%d %H:%M:%S %z') Waiting for the connection to $vpn..."

  if poll_until_connected "$vpn"; then
    echo "$(date '+%Y-%m-%d %H:%M:%S %z') Connected to $vpn!"
    echo "$(date '+%Y-%m-%d %H:%M:%S %z') Starting SSH for VPN"
    ssh -D 127.0.0.1:1080 takaaki@192.168.33.11
    echo "$(date '+%Y-%m-%d %H:%M:%S %z') SSH for VPN has been terminated"
  else
    echo "$(date '+%Y-%m-%d %H:%M:%S %z') Failed to connect to $vpn..."
  fi

  echo "$(date '+%Y-%m-%d %H:%M:%S %z') Waiting for the next try..."
  sleep 5
done
