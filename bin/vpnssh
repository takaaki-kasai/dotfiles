#!/bin/bash

vpn='VPN ConoHa'
enc_sec='H4sIAJYrFl8AA0vOz8vPSCwryAMAThyWVwkAAAA='

function isnt_connected() {
  /usr/sbin/scutil --nc status "$vpn" | sed -n 1p | grep -qv Connected
}

function poll_until_connected() {
  let loops=0 || true
  let max_loops=200 # 200 * 0.1 is 20 seconds. Bash doesn't support floats

  while isnt_connected "$vpn"; do
    sleep 0.1 # can't use a variable here, bash doesn't have floats
    let loops=$loops+1
    [ $loops -gt $max_loops ] && break
  done

  [ $loops -le $max_loops ]
}

while true; do
  if isnt_connected "$vpn"; then
    echo "$(date '+%Y-%m-%d %H:%M:%S %z') Trying to connect to $vpn"
    /usr/sbin/scutil --nc start "$vpn" --secret $(echo -n $enc_sec | base64 -d | gunzip -c)
  fi

  if poll_until_connected "$vpn"; then
    echo "$(date '+%Y-%m-%d %H:%M:%S %z') Connected to $vpn!"
    echo "$(date '+%Y-%m-%d %H:%M:%S %z') Starting SSH for VPN"
    ssh -D 127.0.0.1:1080 takaaki@192.168.33.11
    echo "$(date '+%Y-%m-%d %H:%M:%S %z') SSH for VPN has been terminated"
  else
    echo "$(date '+%Y-%m-%d %H:%M:%S %z') Failed to connect to $vpn..."
    # /usr/sbin/scutil --nc stop "$vpn"
  fi

  echo "$(date '+%Y-%m-%d %H:%M:%S %z') Waiting for the next try..."
  sleep 20
done
